<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Home -- SPA Tests</title>
	<script src='https://unpkg.com/react@16.3.1/umd/react.production.min.js'></script>
	<script src='https://unpkg.com/react-dom@16.3.1/umd/react-dom.production.min.js'>    </script>
	<script src="https://unpkg.com/history/umd/history.production.min.js"></script>
	<script src='https://unpkg.com/react-router-dom@5.0.0/umd/react-router-dom.min.js'></script>
	<script src='https://unpkg.com/babel-standalone@6.26.0/babel.js'></script>
	<script type="text/javascript" src="./assets/js/lightweight-charts-v4.1.0.js" crossorigin="anonymous"></script>
	<style>
		body {
			background-color: #ffffff;
			margin: 0px;
			padding: 0px;
		}

		#loading {
			text-align: center;
			padding: 100px;
		}

		#chart_div {
			margin-top: 0px;
		}

		.chart {
			float: left;
			border: #e1e1e1 solid 1px;
			padding: 0px;
			margin-bottom: 5px;
		}

		.pannel {
			position: absolute;
			padding: 1px 3px;
			clear: both;
			color: #333;
			background-color: #99cc99;
			font-size: 14px;
			z-index: 3;
		}

		#timeframe {
			position: fixed;
			top: 6px;
			right: 15px;
			z-index: 3;
			background-color: #999999;
			padding: 1px 5px;
		}
	</style>
</head>

<body>
	<div id="root"></div>
	<script type="text/babel">
		//https://www.w3schools.com/react/default.asp
		//https://www.pluralsight.com/guides/using-react-router-with-cdn-links
		const Link = ReactRouterDOM.Link;
		const Route = ReactRouterDOM.Route;

		//https://github.com/remix-run/history/blob/dev/docs/installation.md
		//https://github.com/remix-run/history/blob/dev/docs/getting-started.md
		//https://stackoverflow.com/questions/70522486/using-react-router-with-history-js-via-cdn
		const { createBrowserHistory } = window.HistoryLibrary;

		//not the window.history
		const ReactHistory = createBrowserHistory();

		const SYMBOLS = ["EURUSD", "GBPUSD", "AUDUSD", "NZDUSD", "USDJPY", "USDCAD", "USDCHF", "GOLD", "EURGBP", "EURJPY", "EURCHF", "EURAUD", "EURCAD", "EURNZD", "GBPJPY", "GBPCHF", "GBPAUD", "GBPCAD", "GBPNZD", "AUDJPY", "AUDCHF", "AUDNZD", "AUDCAD", "CADJPY", "CADCHF", "NZDJPY", "NZDCHF", "NZDCAD", "CHFJPY"];


		function getChartOption() {
			let width = (screen.width - 20);
			let height = screen.height - 100;
			return {
				width,
				height,
				timeScale: {
					rightOffset: screen.width > 500 ? 5 : 1,
					barSpacing: screen.width > 500 ? 4.25 : 3.75,
					rightBarStaysOnScroll: true,
					fixLeftEdge: false,
					alignLabels: false,
					lockVisibleTimeRangeOnResize: true,
					borderVisible: false,
					visible: false,
					tickMarkFormatter: (time, tickMarkType, locale) => {
						if (LightweightCharts.isUTCTimestamp(time)) {
							return timestampToString(time);
						} else {
							return time;
						}
					},
				},
				rightPriceScale: {
					visible: false,
				},

				layout: {
					textColor: 'black',
					background: { type: 'solid', color: 'white' }
				},
				localization: {
					locale: 'en-US',
					dateFormat: 'yyyy/MM/dd',
					timeFormatter: businessDayOrTimestamp => {
						if (LightweightCharts.isUTCTimestamp(businessDayOrTimestamp)) {
							return timestampToString(businessDayOrTimestamp);
						} else {
							return businessDayOrTimestamp;
						}
					}
				},
				grid: {
					vertLines: {
						color: 'rgba(105 , 105 , 105 , 0.2)',
					},
					horzLines: {
						color: 'rgba(105  , 105  , 105  , 0.2)',
					}
				},
				crosshair: {
					mode: 2,
					vertLine: {
						visible: false
					},
					horzLine: {
						visible: false
					}
				},
				handleScroll: {
					horzTouchDrag: false,
					vertTouchDrag: false,
				}
			};
		}

		function timestampToString(timestamp) {
			const date = new Date(timestamp * 1000);
			const Y = date.getFullYear() + '-';
			const M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
			const D = date.getDate() + ' ';
			const h = date.getHours() + ':';
			const m = date.getMinutes()
			return M + D + h + m;
		}

		class ChartPage extends React.Component {
			constructor(props) {
				super(props);
				this.myRef = React.createRef();
				this.symbol = props.history.location.query.symbol;
			}
			render() {
				const goBack = () => {
					ReactHistory.back()
				}
				return (
					<div>
						<AppBar title={"Chart"} backui={true} />
						<div ref={this.myRef} />
					</div>
				);
			}

			componentDidMount() {
				fetch("https://www.winfirm.com.cn/serv/index_json?symbol=" + this.symbol + "&times=D1")
					.then(res => {
						return res.json();
					}).then(data => {
						const chart = LightweightCharts.createChart(this.myRef.current, getChartOption());
						const candlestickSeries = chart.addCandlestickSeries({
							upColor: '#cc0000', downColor: '#33cc00', borderVisible: false,
							wickUpColor: '#cc0000', wickDownColor: '33cc00',
							priceFormat: {
								type: 'price',
								precision: 6
							}
						});
						const mainPriceOption = {
							scaleMargins: {
								top: 0.05,
								bottom: 0.25
							},
						};
						candlestickSeries.priceScale().applyOptions(mainPriceOption);
						candlestickSeries.setData(data.datas1.datas);
					}).catch(e => {
						console.log(e)
					})
			}
		}

		class AppBar extends React.Component {
			constructor(props) {
				super(props);
			}

			render() {
				const back_style = {
					color: "white",
					float: "left",
					backgroundColor: 'transparent',
					border: '0px',
					width: '30px',
					height: '30px'
				};

				const appbar = {
					backgroundColor: 'grey',
					height: '40px',
					clear: 'both',
					paddingTop: '10px'
				};

				const title = {
					color: 'red',
					textSize: '16px',
					textAlign: 'center'
				};

				if (this.props.backui) {
					const goBack = () => {
						ReactHistory.back()
					}
					return (
						<div style={appbar}>
							<img src='./assets/img/left.png' onClick={goBack} style={back_style} />
							<div style={title}>{this.props.title}</div>
						</div>);
				} else {
					return (
						<div style={appbar}>
							<div style={back_style} />
							<div style={title}>{this.props.title}</div>
						</div>);
				}
			}
		}

		function AboutPage() {
			return (
				<div>
					<AppBar title={"About"} backui={true} />
					<div>
						Spa v1.0
					</div>
				</div>
			);
		}

		function ListPage() {
			let list = [];
			let itemstyle = { clear: '' };

			for (let idx in SYMBOLS) {
				list.push(<li style={itemstyle}><Link to={{ pathname: '/chart', query: { symbol: SYMBOLS[idx] } }} style={itemstyle} symbol={SYMBOLS[idx]}>{SYMBOLS[idx]}</Link></li>);
			}
			return (
				<div>
					<AppBar title={"List"} backui={true} />
					<ul>
						{list}
					</ul>
				</div>
			);
		}

		function HomePage() {
			let list = [];

			let itemstyle = { clear: '' };
			list.push(<li style={itemstyle}><Link to={{ pathname: '/list' }} style={itemstyle}>List Page</Link></li>);
			list.push(<li style={itemstyle}><Link to={{ pathname: '/about' }} style={itemstyle}>About</Link></li>);
			list.push(<li style={itemstyle}><a href={'./list.html'} style={itemstyle}>List[outter]</a></li>);
			list.push(<li style={itemstyle}><a href={'./summary.html'} style={itemstyle}>Summary[outter]</a></li>);
			list.push(<li style={itemstyle}><a href={'./chart.html'} style={itemstyle}>Chart[outter]</a></li>);

			return (
				<div>
					<AppBar title={"Home"} backui={false} />
					<ul>
						{list}
					</ul>
				</div>
			);
		}

		function App() {
			return (
				<ReactRouterDOM.HashRouter>
					<Route path="/" exact component={HomePage} />
					<Route path="/list" component={ListPage} />
					<Route path="/chart" component={ChartPage} />
					<Route path="/about" component={AboutPage} />
				</ReactRouterDOM.HashRouter>
			);
		}

		ReactDOM.render(<App />, document.querySelector('#root'));
	</script>
</body>

</html>
